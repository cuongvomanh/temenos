version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # NGINX Reverse Proxy (Ingress Replacement)
  # ---------------------------------------------------------------------------
  nginx-proxy:
    image: nginx:alpine
    container_name: transact-ingress
    ports:
      - "80:80" # Access T24 via http://localhost/BrowserWeb
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - transact-app
      - transact-web
    networks:
      - transact-net

  # ---------------------------------------------------------------------------
  # ActiveMQ
  # ---------------------------------------------------------------------------
  activemq:
    image: apache/activemq-classic:latest
    container_name: transact-mq
    ports:
      - "8161:8161"
      - "61616:61616"
    environment:
      ACTIVEMQ_USER: user
      ACTIVEMQ_PASSWORD: password
    networks:
      - transact-net

  # ---------------------------------------------------------------------------
  # Transact App (Backend)
  # ---------------------------------------------------------------------------
  transact-app:
    image: transact-app-ora:R25.11.13
    container_name: transact-app
    restart: on-failure
    ports:
      # - "9080:8080" # Optional: Disable direct access if using Nginx
      - "9990:9990" # JBoss Console
    environment:
      - ENV_PREFIX=T24
      - OLTP_ACTIVE=true
      - SERVICE_ACTIVE=false
      - APP_USER=SSOUSER1
      - DB_USER=TAFJ
      - DB_URL=jdbc:oracle:thin:@host.docker.internal:1521/ORCLPDB1
      - JMS_URL=tcp://activemq:61616
      - JMS_USER=user
      - APP_PWD=123456
      - DB_PASSWORD=TAFJ
      - JMS_PASSWORD=password
      - JBOSS_PWD=admin
      - BRP_HOME=/srv/Temenos
      - LOG_HOME=/srv/Temenos/logs
      - EDGE_PROP=SystemTestProperties
      - IDLE_TIMEOUT_VALUE=1
      - JAVA_OPTS=-Xms2g -Xmx6g -Djboss.bind.address=0.0.0.0 -Djboss.bind.address.management=0.0.0.0
      - MDB_POOL_MAX=6
      - DB_POOL_MIN=10
      - DB_POOL_MAX=100
      - MAX_POOL_SIZE=200
    # volumes:
    #   - ./shares:/shares
    # ADD THIS SECTION ðŸ‘‡
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - transact-net

  # ---------------------------------------------------------------------------
  # Transact Web (Frontend)
  # ---------------------------------------------------------------------------
  transact-web:
    image: transact-web:R25.13
    container_name: transact-web
    restart: on-failure
    depends_on:
      - transact-app
    ports:
      # - "8081:8080" # Optional: Disable direct access if using Nginx
      - "8081:8080"   # Kept enabled for debugging if needed, otherwise comment out
    environment:
      - TE_TB_SERVER_URL=http://transact-app:8080
      - JMS_URL=tcp://activemq:61616
      - JMS_USER=user
      - JMS_PASSWORD=password
      - JBOSS_PWD=admin
      - WWW_PORT=8080
      - BRP_HOME=/srv/Temenos
      - LOG_HOME=/srv/Temenos
      - EDGE_PROP=SystemTestProperties
      - JAVA_OPTS=-Xms2g -Xmx4g -Djboss.bind.address=0.0.0.0
    networks:
      - transact-net

networks:
  transact-net:
    driver: bridge